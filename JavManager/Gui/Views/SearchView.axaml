<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:JavManager.Gui.ViewModels"
             xmlns:views="using:JavManager.Gui.Views"
             x:Class="JavManager.Gui.Views.SearchView"
             x:DataType="vm:SearchViewModel"
             x:Name="Root">

    <Grid RowDefinitions="Auto,Auto,*,Auto" Margin="16">
        <!-- Search Bar -->
        <Grid Grid.Row="0" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
            <TextBox Grid.Column="0" 
                     Text="{Binding SearchQuery}"
                     Watermark="{Binding Loc[Gui_Search_Watermark]}"
                     Margin="0,0,8,0">
                <TextBox.KeyBindings>
                    <KeyBinding Gesture="Enter" Command="{Binding SearchCommand}" />
                </TextBox.KeyBindings>
            </TextBox>
            <Button Grid.Column="1" 
                    Content="{Binding Loc[Gui_Search_ButtonSearch]}" 
                    Command="{Binding SearchCommand}"
                    IsEnabled="{Binding !IsSearching}"
                    Classes="accent"
                    MinWidth="100"/>
        </Grid>

        <!-- Search Options -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" Margin="0,0,0,12">
            <CheckBox Grid.Column="0"
                      Content="{Binding Loc[Gui_Search_OptionRemote]}"
                      IsChecked="{Binding SearchRemote}"
                      HorizontalAlignment="Left" />
            <CheckBox Grid.Column="1"
                      Content="{Binding Loc[Gui_Search_OptionLocal]}"
                      IsChecked="{Binding SearchLocal}"
                      HorizontalAlignment="Right" />
        </Grid>

        <!-- Results Area -->
        <Grid Grid.Row="2" ColumnDefinitions="*,*">
            <!-- Remote Results / Torrents (two-step) -->
            <Border Grid.Column="0" 
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" 
                    BorderThickness="1" 
                    CornerRadius="4"
                    Margin="0,0,8,0">
                <Grid RowDefinitions="Auto,*">
                    <!-- Remote candidates header -->
                    <TextBlock Grid.Row="0"
                               Text="{Binding Loc[Gui_Search_SectionRemoteResults]}"
                               FontWeight="SemiBold"
                               Margin="12,8"
                               IsVisible="{Binding SelectedCandidate, Converter={x:Static ObjectConverters.IsNull}}"/>

                    <!-- Torrents header -->
                    <Grid Grid.Row="0"
                          RowDefinitions="Auto,Auto"
                          ColumnDefinitions="*,Auto"
                          Margin="12,8"
                          IsVisible="{Binding SelectedCandidate, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <TextBlock Grid.Row="0"
                                   Grid.Column="0"
                                   Text="{Binding Loc[Gui_Search_SectionTorrents]}"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                        <Button Grid.Row="0"
                                Grid.Column="1"
                                Content="{Binding Loc[Gui_Common_Back]}"
                                Command="{Binding BackToResultsCommand}"
                                Margin="8,0,0,0"/>
                        <TextBlock Grid.Row="1"
                                   Grid.ColumnSpan="2"
                                   Text="{Binding Loc[Gui_Search_TorrentMarkersHint]}"
                                   FontSize="12"
                                   Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                   Margin="0,4,0,0"/>
                    </Grid>

                    <!-- Remote candidates list -->
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding RemoteCandidates}"
                             SelectedItem="{Binding SelectedCandidate}"
                             SelectionMode="Single"
                             IsVisible="{Binding SelectedCandidate, Converter={x:Static ObjectConverters.IsNull}}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="Auto,*" Margin="4">
                                    <TextBlock Grid.Column="0"
                                               Text="{Binding JavId}"
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               Width="90"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding Title}"
                                               TextTrimming="CharacterEllipsis"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Torrents list -->
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding SearchResults}"
                             SelectedItem="{Binding SelectedTorrent}"
                             SelectionMode="Single"
                             IsVisible="{Binding SelectedCandidate, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" Margin="4">
                                    <TextBlock Grid.Column="0" Text="{Binding Title}" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Grid.Column="1" Text="UC" IsVisible="{Binding HasUncensoredMarker}" 
                                               Foreground="Green" FontWeight="Bold" Margin="8,0"/>
                                    <TextBlock Grid.Column="2" Text="SUB" IsVisible="{Binding HasSubtitle}" 
                                               Foreground="Blue" FontWeight="Bold" Margin="8,0"/>
                                    <TextBlock Grid.Column="3" Text="HD" IsVisible="{Binding HasHd}" 
                                               Foreground="Orange" FontWeight="Bold" Margin="8,0"/>
                                    <TextBlock Grid.Column="4" Text="{Binding SizeDisplay}" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               Width="70" TextAlignment="Right"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Local Files -->
            <Border Grid.Column="1" 
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumLowBrush}" 
                    BorderThickness="1" 
                    CornerRadius="4"
                    Margin="8,0,0,0">
                <Grid RowDefinitions="Auto,*">
                    <TextBlock Grid.Row="0" Text="{Binding Loc[Gui_Search_SectionLocalFiles]}" FontWeight="SemiBold" Margin="12,8"/>
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding LocalFiles}"
                             SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,Auto,Auto" Margin="4">
                                    <TextBlock Grid.Column="0" Text="{Binding FileName}" TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Grid.Column="1" Text="{Binding SizeDisplay}" 
                                               Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                               Width="70" TextAlignment="Right"/>
                                    <Button Grid.Column="2"
                                            Content="{Binding ViewModel.Loc[Gui_Common_OpenFolder], RelativeSource={RelativeSource AncestorType=views:SearchView}}"
                                            Command="{Binding ViewModel.OpenLocalFileFolderCommand, RelativeSource={RelativeSource AncestorType=views:SearchView}}"
                                            CommandParameter="{Binding}"
                                            Margin="8,0,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>
        </Grid>

        <!-- Bottom Action Bar -->
        <Grid Grid.Row="3" ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto,Auto" Margin="0,12,0,0">
            <TextBlock Grid.Column="0"
                       Grid.RowSpan="2"
                       Text="{Binding StatusMessage}"
                       TextWrapping="NoWrap"
                       TextTrimming="CharacterEllipsis"
                       ToolTip.Tip="{Binding StatusMessage}"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"/>
            <Button Grid.Column="1"
                    Grid.Row="0"
                    Content="{Binding Loc[Gui_Search_ButtonCopyMagnet]}"
                    Command="{Binding CopyMagnetLinkCommand}"
                    IsEnabled="{Binding SelectedTorrent, Converter={x:Static ObjectConverters.IsNotNull}}"
                    Margin="0,0,8,0"
                    VerticalAlignment="Top"/>
            <Button Grid.Column="2"
                    Grid.Row="0"
                    Content="{Binding Loc[Gui_Search_ButtonDownload]}"
                    Command="{Binding DownloadSelectedCommand}"
                    IsEnabled="{Binding SelectedTorrent, Converter={x:Static ObjectConverters.IsNotNull}}"
                    Classes="accent"
                    VerticalAlignment="Top"/>
        </Grid>
    </Grid>

    <UserControl.Styles>
        <Style Selector="Button.accent">
            <Setter Property="Background" Value="{DynamicResource SystemAccentColor}"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
    </UserControl.Styles>
</UserControl>
